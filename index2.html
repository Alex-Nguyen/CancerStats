<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Rose chart for Cancer</title>
    <!-- Stylesheets -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <!-- Scripts -->
    <script type="text/javascript" src="Scripts/script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.1/bootstrap-slider.min.js"></script>
    <script src="http://code.jquery.com/jquery-3.2.1.js"></script>
    <link rel="stylesheet" type="text/css" href="style/bootstrap-slider.css">
    <link rel="stylesheet" type="text/css" href="style/bootstrap.min.css">
</head>
<style>
    td{
        text-align: center;
    }
    .arc{
        fill:#bc96a5;
        stroke: black;
    }
    .link {
        stroke: #ccc;
    }

    .node text {
        font: 10px sans-serif;
    }
    .well {
        background-color: #E0E0E0;
    }

</style>
<body>
<div id="cancer">

</div>
<div>
    <div class="well">
        <input id="slider"  type="text" data-slider-min="0.0001" value="0.05" data-slider-max="1" data-slider-step="0.05" />
    </div>
    <div><a href="index.html">Click here </a> to go to set 1</div>
</div>
<div id="colorlegend" style="margin-top: 10px">

</div>
<script>
    var slider = new Slider('#slider', {
        min: 0.001,
        max: 1,
        value:0.05,
        tooltip:'always',
        scale: 'logarithmic',
        step: 0.05
    });
    slider.on("slide", function(sliderValue) {
        d3.selectAll(".thresholdcircle").attr("r",SignificantScale(sliderValue));
//
        var arc = d3.selectAll(".arc");
        arc.style("opacity",function (d) {
            return d.value <=sliderValue ? 1:0.1;
        });
    });


</script>

<table width="100%" border="1" style="border-collapse: collapse;">
    <tr id="row1">
        <td>N/A</td>
        <td>ARHGEF10L</td>
        <td>COL18A1</td>
        <td>CUX2</td>
        <td>FOXO4</td>
        <td>PTPN6</td>
        <td>TIAM1</td>
        <td>ZBTB33</td>
        <td>RALBP1</td>
    </tr>
    <tr id="row2">
        <td>ARHGEF10L</td>
        <td class="ARHGEF10L-ARHGEF10L"></td>
        <td class="COL18A1-ARHGEF10L"></td>
        <td class="CUX2-ARHGEF10L"></td>
        <td class="FOXO4-ARHGEF10L"></td>
        <td class="PTPN6-ARHGEF10L"></td>
        <td class="ARHGEF10L-TIAM1"></td>
        <td class="ARHGEF10L-ZBTB33"></td>
        <td class="ARHGEF10L-RALBP1"></td>
    </tr>
    <tr id="row3">
        <td>COL18A1</td>
        <td class="COL18A1-ARHGEF10L"></td>
        <td class="COL18A1-COL18A1"></td>
        <td class="COL18A1-CUX2"></td>
        <td class="COL18A1-FOXO4"></td>
        <td class="PTPN6-COL18A1"></td>
        <td class="COL18A1-TIAM1"></td>
        <td class="COL18A1-ZBTB33"></td>
        <td class="COL18A1-RALBP1"></td>
    </tr>
    <tr id="row4">
        <td>CUX2</td>
        <td class="CUX2-ARHGEF10L"></td>
        <td class="COL18A1-CUX2"></td>
        <td class="CUX2-CUX2"></td>
        <td class="FOXO4-CUX2"></td>
        <td class="PTPN6-CUX2"></td>
        <td class="CUX2-TIAM1"></td>
        <td class="CUX2-ZBTB33"></td>
        <td class="CUX2-RALBP1"></td>
    </tr>
    <tr id="row5">
        <td>FOXO4</td>
        <td class="FOXO4-ARHGEF10L"></td>
        <td class="COL18A1-FOXO4"></td>
        <td class="FOXO4-CUX2"></td>
        <td class="FOXO4-FOXO4"></td>
        <td class="PTPN6-FOXO4"></td>
        <td class="FOXO4-TIAM1"></td>
        <td class="FOXO4-ZBTB33"></td>
        <td class="FOXO4-RALBP1"></td>
    </tr>
    <tr id="row6">
        <td>PTPN6</td>
        <td class="PTPN6-ARHGEF10L"></td>
        <td class="PTPN6-COL18A1"></td>
        <td class="PTPN6-CUX2"></td>
        <td class="PTPN6-FOXO4"></td>
        <td class="PTPN6-PTPN6"></td>
        <td class="PTPN6-TIAM1"></td>
        <td class="PTPN6-ZBTB33"></td>
        <td class="PTPN6-RALBP1"></td>
    </tr>
    <tr id="row7">
        <td>TIAM1</td>
        <td class="ARHGEF10L-TIAM1"></td>
        <td class="COL18A1-TIAM1"></td>
        <td class="CUX2-TIAM1"></td>
        <td class="FOXO4-TIAM1"></td>
        <td class="PTPN6-TIAM1"></td>
        <td class="TIAM1-TIAM1"></td>
        <td class="TIAM1-ZBTB33"></td>
        <td class="TIAM1-RALBP1"></td>
    </tr>
    <tr id="row8">
        <td>ZBTB33</td>
        <td class="ARHGEF10L-ZBTB33"></td>
        <td class="COL18A1-ZBTB33"></td>
        <td class="CUX2-ZBTB33"></td>
        <td class="FOXO4-ZBTB33"></td>
        <td class="PTPN6-ZBTB33"></td>
        <td class="TIAM1-ZBTB33"></td>
        <td class="ZBTB33-ZBTB33"></td>
        <td class="ZBTB33-RALBP1"></td>
    </tr>
</table>
<script>
    var fwidth = 960, fheight =600;

    var svg = d3.select("body").append("svg")
        .attr("width", fwidth)
        .attr("height", fheight);

    var force = d3.layout.force()
        .distance(350)
        .charge(-300)
        .size([fwidth, fheight]);
    var globalData;
    var c20 = d3.scale.category20();
    var slider = document.getElementById('slider');
    function SignificantScale( x) {
        var RadiusScale ;
        if(x<=0.05){
            RadiusScale =  d3.scale.linear().domain([0,0.05]).range([70,30]);
        }else{
            RadiusScale =  d3.scale.linear().domain([0.05,1]).range([30,5]);
        }
        return RadiusScale(x);
    }
    // var RadiusScale = d3.scale.linear().domain([0,1]).range([70,5]);

    // Load the JSON data:
    d3.csv( 'Data/Data2.csv', function( data ) {
        globalData = data.filter(function (d) {
            return d['p-Value']<document.getElementById('slider').value;
        });
        var Pairwise = new Object();
        var tp53data = {"edges":[]};
        var geneArr =[];
        data.forEach(function (d) {

            var geneA = d.geneA, geneB = d.geneB;
            if(geneA=="TP53"||geneB=="TP53"){
                if(geneArr.indexOf(geneA)<0){
                    geneArr.push(geneA);
                }
                if(geneArr.indexOf(geneB)<0){
                    geneArr.push(geneB);
                }
                tp53data.edges.push({"source":{"id":geneArr.indexOf(geneA), "label": geneA}, "target":{"id":geneArr.indexOf(geneB),"label":geneB},"name":d.Cancer,"value":d['p-Value']})

            }
            if(!Pairwise.hasOwnProperty(d.geneA+"-"+d.geneB)){
                Pairwise[d.geneA+"-"+d.geneB]=[];
                Pairwise[d.geneA+"-"+d.geneB].push({"id":0,"pairwise": d.geneA+"-"+d.geneB,"name":d.Cancer,"value":d['p-Value'],"coocurrence":d.Association});
            }
            else{
                Pairwise[d.geneA+"-"+d.geneB].push({"id":Pairwise[geneA+"-"+d.geneB].length,"pairwise": d.geneA+"-"+d.geneB,"name":d.Cancer,"value":d['p-Value'],"coocurrence":d.Association});
            }
        })


        // Get the maximum value:
        for(var key in Pairwise){
            var svg = d3.selectAll("."+key)
                .append("svg")
                .attr("width", 200)
                .attr("height", 200)
                .append("g")
                .attr("transform", "translate(100,100)");

            var arc = d3.svg.arc();

            var path =  svg.selectAll("path").data(Pairwise[key]).enter().append("g");
            path.append("path")
                .attr("class", "arc")
                .style("opacity",function (d) {
                    return d.value <=document.getElementById('slider').value ? 1:0.1;
                })
                .style("fill",function (d) {
                    return c20(d.id);
                })
                .style("stroke",function (d) {
                    return d.coocurrence.indexOf("co-occurrence")>=0?"black":"white";
                })
                .attr("id", function (d,i) {
                    return "arc_"+i;
                })
                .attr("d", function (d,i) {
                    arc.outerRadius(SignificantScale(d.value));
                    arc.innerRadius(0);
                    arc.startAngle(d.id*2*Math.PI/20);
                    arc.endAngle((d.id+1)*2*Math.PI/20);
                    return arc(d);
                })
                .append("title").text(function (d) {
                return d.name + ": "+d.value;
            });
            path.append("circle")
                .attr("class","thresholdcircle")
                .attr("r",function (d) {
                    return SignificantScale(document.getElementById("slider").value);
                })
                .style("fill","none")
                .style("stroke","red")
                .style("stroke-dasharray","3 3");

            path.append("circle")
                .attr("r",function (d) {
                    return SignificantScale(0);
                })
                .style("fill","none")
                .style("stroke","black")
                .style("stroke-dasharray","2 2");
            path.append("circle")
                .attr("r",function (d) {
                    return SignificantScale(0.05);
                })
                .style("fill","none")
                .style("stroke","black")
                .style("stroke-dasharray","2 2");
            svg.append("text").text("p=0").attr("x",71)




        }

        // Where the maximum value gives us the maximum radius:
        var legend = d3.select("#colorlegend").append("svg").attr("width",1200).attr("height",100);
        var xvalue = legend.selectAll("g").data(Pairwise["ARHGEF10L-RALBP1"]).enter().append("g");
        xvalue.append("rect").attr("width",12).attr("height",12).style("fill",function (d,i) {
            return c20(i);
        }).attr("x",function (d,i) {
            return (i%5)*200;
        }).attr("y",function (d,i) {
            return Math.floor(i/5)*25;

        });
        xvalue.append("text").style("font-size","11px").text(function (d) {
            return d.name;
        }).attr("x",function (d,i) {
            return (i%5)*200+20;
        }).attr("y",function (d,i) {
            return Math.floor(i/5)*25+10;

        })
        var graph={"nodes":[],"links":[]};

   globalData.forEach(function (d) {
       //Populate nodes
       var result = Object.keys(graph.nodes).map(function(key) {
           return graph.nodes[key].name;
       });
       if(result.indexOf(d.geneA)==-1){
           graph.nodes.push({"id":result.length,"name":d.geneA});
       }
       if(result.indexOf(d.geneB)==-1){
           graph.nodes.push({"id":result.length,"name":d.geneB});
       }
   })
        var serialnodes =  Object.keys(graph.nodes).map(function(key) {
            return graph.nodes[key].name;
        });
        globalData.forEach(function (d) {
            //Fist check if graph.links contain existing links.
//            var found = false;
//            for(var item=0;item<graph.links.length;item++){
//                if((graph.links[item].source==d.geneA&&graph.links[item].target==g.geneB)||(graph.links[item].source==d.geneB&&graph.links[item].target==g.geneA)){
//                    graph.links[item].values.push(d['p-Value'])
//                  //  found=true;
//                }
//            }
//            if(found=false){
                graph.links.push({"source":serialnodes.indexOf(d.geneA),"target":serialnodes.indexOf(d.geneB),"values":[d['p-Value']]})


        });


        update(graph.nodes,graph.links);




    });

    function update(nodes,links) {
        force
            .nodes(nodes)
            .links(links)
            .start();

        var link = svg.selectAll(".link")
            .data(links)
            .enter().append("line")
            .attr("class", "link");

        var node = svg.selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(force.drag);

        node.append("circle").attr("r",20).style("stroke","red").style("fill","red")

        node.append("text")
            .attr("dx", 22)
            .attr("dy", ".35em")
            .text(function(d) { return d.name });

        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        });

    }






</script>
</body>
</html>